---
title: "Early-warnings signals in ecological systems"
author: "Roberto √Ålvarez. Universidad Aut√≥noma de Quer√©taro"
date: "`r format(Sys.time(), '%d %B, %Y')`"
output:
  html_document: 
    fig_height: 8
    fig_width: 13
    number_section: yes
    theme: cerulean
    toc: yes
    toc_float:
      collapsed: no
      smooth_scroll: yes
  pdf_document:
    toc: yes
  word_document:
    toc: yes
editor_options: 
  markdown: 
    wrap: 72
---

## Introducci√≥n

En este tutorial aprender√°s a detectar **se√±ales de alerta temprana
(EWS)** con el paquete **`EWSmethods`**.\
Lo dividiremos en tres partes:

1.  Medidas **univariadas** (`uniEWS()`)
2.  Medidas **multivariadas** (`multiEWS()`)
3.  **Deep‚ÄëLearning** con **EWSNet** (`ewsnet_*()`)

Cada secci√≥n ofrece ejemplos reproducibles y un bloque de
**ejercicios**.

```{r libraries, message=FALSE, warning=FALSE}
library(EWSmethods)
library(tidyverse)
library(patchwork)
```

------------------------------------------------------------------------

| **M√©trica univariada (EWS)** | **Tendencia al acercarse a la transici√≥n** | **Raz√≥n simplificada** |
|-----------------|-----------------|---------------------------------------|
| Varianza (o Desviaci√≥n est√°ndar) | **‚Üë Sube** | Al desacelerarse la recuperaci√≥n (critical slowing down) las perturbaciones se ‚Äúacumulan‚Äù y la serie fluct√∫a cada vez con mayor amplitud. |
| Autocorrelaci√≥n lag-1 (AR1) | **‚Üë Sube** (se acerca a 1) | Un sistema lento ‚Äúse parece‚Äù m√°s a su estado anterior; los valores consecutivos se correlacionan m√°s fuertemente. |
| Tiempo de retorno (1/Œª) o tasa de recuperaci√≥n | **‚Üë Sube** (la tasa Œª ‚Üì) | El eigenvalor dominante del sistema se aproxima a 0; por eso tarda m√°s en volver al equilibrio tras una perturbaci√≥n. |
| Coeficiente de variaci√≥n (CV = SD/Œº) | **‚Üë Sube** | La varianza crece mientras la media suele cambiar poco; la relaci√≥n SD/Œº aumenta. |
| Skewness (asimetr√≠a) | **‚Üë / ‚Üì** seg√∫n el lado del punto cr¬¥tico | El pozo de potencial se deforma: la cola de la distribuci√≥n se alarga hacia el estado alternativo, generando asimetr√≠a. |
| Kurtosis (exceso) | **‚Üë (frecuente)** | Colas m√°s pesadas/‚Äúpicos‚Äù m√°s agudos por excursiones ocasionales y bruscas lejos del equilibrio. |
| Espectro en baja frecuencia (‚Äúreddening‚Äù) | **‚Üë Sube** (m√°s potencia a bajas f) | Las oscilaciones lentas dominan porque el sistema filtra las altas frecuencias al volverse m√°s lento en su recuperaci√≥n. |
| Ratio varianza detrendida / total | **‚Üë Sube** | Aun despu√©s de quitar la tendencia, lo ‚Äúruidoso‚Äù residual aumenta, se√±al de resiliencia menguante. |
| Entrop√≠a de la se√±al | **‚Üì Baja** (a veces) | Con din√°micas m√°s lentas, la serie se vuelve m√°s predecible; la informaci√≥n nueva por unidad de tiempo disminuye. |

## Medidas univariadas

En esta secci√≥n aprender√°s a calcular medidas univariadas de EWS, que
son indicadores estad√≠sticos de cambios en la din√°mica de una serie
temporal.

El objeto `simTransComms` contiene tres r√©plicas simuladas de una
comunidad con cinco especies. En cada r√©plica, la comunidad ha sido
forzada hacia una transici√≥n cr√≠tica como resultado de la introducci√≥n
de una especie invasora. Este conjunto de datos est√° basado en la
simulaci√≥n descrita por Dakos (2018).

Dependiendo del tipo de an√°lisis, podemos usar simTransComms de dos
maneras:

-   An√°lisis multivariado con `multiEWS()` Usaremos todas las series de
    abundancia de las cinco especies de manera conjunta para detectar
    se√±ales tempranas que afectan al sistema como un todo.
-   An√°lisis univariado con `uniEWS()` Tambi√©n podemos seleccionar una
    sola serie temporal (por ejemplo, una sola especie) y aplicar los
    an√°lisis de forma individual. Esto nos permitir√° comparar si los
    patrones de alerta se detectan mejor en an√°lisis integrados
    (multivariados) o por separado (univariados).

Vamos a usar este objeto como ejemplo para aplicar an√°lisis de se√±ales
de alerta temprana en comunidades multiespecie.

`CODrecovery` tiene tres r√©plicas simuladas de una poblaci√≥n de bacalao
( *Gadus morhua* ) que pasa de un estado de pesca intensiva seguido de
una pesca moderada. Esto datos fueron publicados por Clements *et al.*
en 2019.

```{r}
data("simTransComms")

data("CODrecovery")
```

Visualizamos las series de abundancia de bacalao:

```{r}
plot(x = CODrecovery$scenario2$time, y = CODrecovery$scenario2$biomass, type = "l", xlab = "Year", ylab = "Abundance", main = "Recovering cod population")
```

Versi√≥n mejorada en ggplot2

```{r}
ggplot(CODrecovery$scenario2,            # el data frame
       aes(x = time, y = biomass)) +     # mapeo est√©tico
  geom_line(size = 1) +                  # l√≠nea continua
  labs(
    title = "Recovering cod population",
    x = "Year",
    y = "Abundance"
  ) +
  theme_minimal(base_size = 14)    
```

**Ejercicios**

-   Explora el objeto `CODrecovery` y analiza las series de abundancia
    de bacalao.
-   Crea un gr√°fico que muestre las tres r√©plicas de la serie de
    abundancia de bacalao en un solo gr√°fico.
-   ¬øQu√© patrones observas en las series de abundancia de bacalao?
-   Grafica las 5 species juntas
-   ¬øQu√© significa el valor inflection_pt?

Sin embargo , para evaluar se√±ales de alerta **temprana** (EWS) los
datos deben ser analizados antes de una transici√≥n cr√≠tica. Por lo que,
para estos casos vamos a truncar lso datos previo a esa transici√≥n.

```{r}
pre_CODrecovery <- subset(CODrecovery$scenario2,time < inflection_pt)
pre_simTransComms <- subset(simTransComms$community1,time < inflection_pt)

```

Veamos c√≥mo se ven los datos

```{r}
#plot(pre_CODrecovery$scenario2$time,pre_CODrecovery$scenario2$biomass, type = "l", xlab = "Year", ylab = "Abundance", main = "Recovering cod population")
```

## Ventanas deslizantes

Uno de los m√©todos m√°s utilizados para calcular se√±ales de alerta
temprana es el enfoque de **ventanas deslizantes**, gracias a los
trabajos pioneros de Dakos et al. (2012) y al desarrollo del paquete
`earlywarnings`. Este enfoque consiste en analizar fragmentos m√≥viles de
una serie de tiempo para detectar cambios sutiles en indicadores como la
varianza, la autocorrelaci√≥n o la asimetr√≠a (*skewness*) antes de una
transici√≥n cr√≠tica.

En el paquete `EWSmethods`, la funci√≥n `uniEWS()` permite aplicar este
enfoque de forma sencilla. Puedes ajustar dos argumentos clave:

1.  `method =` permite especificar el tipo de an√°lisis (por ejemplo,
    rolling o expanding).
2.  `winsize =` define el tama√±o de la ventana como un porcentaje del
    total de la serie de tiempo. Por ejemplo, winsize = 50 usar√° una
    ventana que cubre el 50% de los datos y se mover√° a lo largo del
    tiempo.

![Ventana deslizante](RollingWindow.png)

```{r}
rolling_ews_eg <- uniEWS(data = pre_simTransComms[,c(2,5)],
                         metrics = c("ar1","SD","skew"),
                         method = "rolling",winsize = 50)
```

```{r}
plot(rolling_ews_eg,  y_lab = "Density")
```

### Limitaciones del enfoque de ventanas deslizantes

El m√©todo de ventanas deslizantes es muy utilizado por su simplicidad,
pero esta misma caracter√≠stica puede limitar su utilidad en ciertas
situaciones.

En este enfoque, una se√±al de advertencia (EWS) se considera detectada
cuando el indicador (por ejemplo, la varianza, la autocorrelaci√≥n o la
asimetr√≠a) muestra una correlaci√≥n positiva fuerte con el tiempo. Esta
relaci√≥n se mide com√∫nmente con el coeficiente de Tau de Kendall, que
indica si el indicador tiende a aumentar conforme nos acercamos a una
posible transici√≥n cr√≠tica.

**¬øCu√°l es el problema?**

El problema es que este enfoque puede generar **falsas alarmas**. Es
decir, puede indicar que hay una se√±al de alerta temprana cuando en
realidad no la hay. Esto sucede porque el m√©todo de ventanas deslizantes
no considera adecuadamente la variabilidad natural de los datos y puede
detectar correlaciones que no son relevantes para la transici√≥n cr√≠tica.
No existe un consenso claro sobre qu√© tan fuerte debe ser esa
correlaci√≥n para considerarse realmente una alerta. En la literatura se
han propuesto valores muy variados: desde 0.5 hasta 0.9 (Dakos et al.
2012, Dablander et al. 2022, Southall et al. 2022). Esto sugiere que el
umbral de alarma es dependiente del contexto y del tipo de sistema
ecol√≥gico o social que se est√© estudiando.

### ¬øQu√© alternativa existe?

Para abordar este problema,**Dakos et al. (2012)** propusieron un
enfoque m√°s robusto basado en **permutaciones aleatorias**:

1.  A partir de la serie de tiempo original, se generan muchas versiones
    **aleatorias** (reordenadas).

2.  Para cada una de esas versiones permutadas, se calcula tambi√©n el
    coeficiente Tau de Kendall.

3.  Luego, se compara el coeficiente de la serie original con la
    distribuci√≥n obtenida de las permutaciones.

**Si el coeficiente de la serie original es mayor que el 95% de los
coeficientes permutados**, entonces se considera una **se√±al
estad√≠sticamente significativa de advertencia**.

## Ventanas expandibles

Este m√©todo puede ser especialmente √∫til para reducir la cantidad de
**falsas alarmas** cuando se trabaja con series de tiempo cortas o muy
variables.

Para utilizarlo con la funci√≥n `uniEWS()`, solo necesitamos hacer dos
cambios:

-   Cambiar el argumento `method =` a`"expanding"`.

-   Sustituir`winsize =`por`burn_in =`, que define el**n√∫mero de puntos
    iniciales**que se usar√°n como referencia el algoritmo antes de
    comenzar a calcular los indicadores de alerta temprana.

### ¬øPor qu√© usar `burn_in`?

Este par√°metro le indica a la funci√≥n cu√°ntos datos considerar al inicio
como **base de referencia**(es decir, cuando todav√≠a no se espera una
transici√≥n). Luego, conforme avanza el tiempo, se van incorporando
nuevos puntos a la serie de manera acumulativa.

Esto ayuda a evitar problemas frecuentes al comienzo del an√°lisis, como:

-   Resultados ruidosos cuando hay pocos datos.

-   Falsas se√±ales de advertencia provocadas por fluctuaciones naturales
    que ocurren al inicio.

Seg√∫n O‚ÄôBrien & Clements (2021), el uso de`burn_in`en el enfoque
expansivo**mejora la confiabilidad**de los an√°lisis en comparaci√≥n con
el uso de ventanas deslizantes en series muy cortas o altamente
variables.

![Ventana expandible](ExpandingWindow.png)

```{r}
expanding_ews_eg <- uniEWS(data = pre_simTransComms[,c(2,5)],
                         metrics = c("ar1","SD","skew"),
                         method = "expanding",
                         burn_in = 50,
                         threshold = 2)
```

```{r}
plot(expanding_ews_eg, y_lab = "Density")
```

### Confirmando se√±ales de advertencia con ventanas expansivas y m√©tricas compuestas

Al igual que con el enfoque de ventanas deslizantes, el uso de
**ventanas expansivas** permite detectar se√±ales de alerta temprana
cuando los indicadores ‚Äîcomo la autocorrelaci√≥n (AR1), la desviaci√≥n
est√°ndar (SD) o la asimetr√≠a (skewness)‚Äî **superan un umbral cr√≠tico**,
com√∫nmente definido como **2 desviaciones est√°ndar (2œÉ)** por encima de
su media.

üîç En este caso, varios indicadores superaron el umbral en **m√°s de dos
momentos consecutivos a partir del tiempo \~170**, lo que sugiere una
**posible transici√≥n cr√≠tica inminente**.

------------------------------------------------------------------------

### ¬øPor qu√© confiar m√°s en esta se√±al?

Aunque cada indicador individual puede ofrecer pistas, la evidencia es
**m√°s robusta** cuando estos indicadores se combinan en lo que se llama
una **m√©trica compuesta**. En este an√°lisis:

-   Se calcul√≥ una m√©trica compuesta sumando los valores**normalizados
    (estandarizados)**de AR1, SD y skewness.

-   Esta m√©trica tambi√©n mostr√≥ una se√±al clara desde el tiempo
    \~170,**reforzando la confianza**en la advertencia detectada.

Seg√∫n Clements & Ozgul (2016), las m√©tricas compuestas suelen ser m√°s
confiables que los indicadores individuales, ya que **integran
diferentes dimensiones de p√©rdida de resiliencia** y reducen el riesgo
de falsos positivos debidos al comportamiento err√°tico de un solo
indicador.

### Integraci√≥n de informaci√≥n de rasgos en EWS: mejorando la detecci√≥n

Una de las funcionalidades m√°s avanzadas que ofrece la funci√≥n
`uniEWS()` es la posibilidad de **combinar m√∫ltiples fuentes de
informaci√≥n** al momento de evaluar se√±ales de alerta temprana.

Adem√°s de analizar solo los cambios en la abundancia o biomasa, es
posible incorporar **rasgos funcionales**, como el tama√±o corporal, que
pueden reflejar cambios en la fisiolog√≠a, el comportamiento o la
ecolog√≠a de una especie.

------------------------------------------------------------------------

### ¬øPor qu√© esto es importante?

Estudios recientes (Clements & Ozgul, 2016; Baruah et al., 2020) han
demostrado que incorporar informaci√≥n de rasgos mejora considerablemente
la precisi√≥n del an√°lisis.\
En particular, permite:

-   **Reducir la tasa de falsos positivos**, es decir, evitar se√±ales
    que parecen advertencias pero no lo son.

-   **Incrementar la detecci√≥n de verdaderos positivos**, es decir,
    se√±ales reales de que el sistema se est√° acercando a una transici√≥n
    cr√≠tica.

------------------------------------------------------------------------

### ¬øC√≥mo se usa esto en `uniEWS()`?

Para activar esta funcionalidad, hay que cumplir tres condiciones:

1.  Usar `method = "expanding"`(ventana expansiva).

2.  Incluir`"trait"` dentro del argumento `metrics =`.

3.  Proporcionar una **serie de tiempo adicional** en el argumento
    `trait =`, que contenga el valor del rasgo (por ejemplo, tama√±o
    corporal) correspondiente a cada punto de tiempo.

Al cumplir estos requisitos, `uniEWS()`**combina los indicadores basados
en abundancia con los cambios observados en el rasgo**y genera una
**m√©trica compuesta m√°s robusta**.

```{r}
trait_ews_eg <- uniEWS(data = pre_CODrecovery[,c(2,3)],
                         metrics = c("ar1","SD","trait"), #note "trait" is provided here
                         method = "expanding",
                         trait = pre_CODrecovery$mean.size, #and here
                         burn_in = 15, #small burn_in due to shorter time series
                         threshold = 2)
```

```{r}
plot(trait_ews_eg, y_lab = "Density", trait_lab = "Mean size (g)")

```

## Ejercicios (Tarea cortes√≠a de C√©sar)

Considera los datos de Tripati et al 2005 (`end_of_greenhouse.txt`), de Chen et al 2018 (`dryland_ecosystems.txt`) y de DeMenocal et al 2001 (`desertification.txt`) que les proporciono

Utilizando el paquete `EWSmethods`, realiza los siguientes pasos: 

1.Carga los datos y visualiza las series de tiempo. 

2. Aplica el an√°lisis de se√±ales de alerta temprana
univariado utilizando el enfoque de ventanas deslizantes
(`method = "rolling"`). 

3. Repite el an√°lisis utilizando el enfoque de
ventanas expansivas (`method = "expanding"`). 

4. Compara los resultados
de ambos enfoques y discute las diferencias observadas.

## Referencias clave

-   Dakos et al.(2012) *PLoS ONE* ‚Äì Early‚Äëwarning signals in ecological
    transitions.

-   O'brien, D. A., & Clements, C. F. (2021). Early warning signal
    reliability varies with COVID-19 waves. *Biology Letters*, *17*(12),
    20210487

-   Deb, S., Sidheekh, S., Clements, C. F., Krishnan, N. C., &
    Dutta, P. S. (2022). Machine learning methods trained on simple
    models can predict critical transitions in complex natural systems.
    *Royal Society Open Science*, *9*(2), 211475.

-   Weinans, E., Quax, R., van Nes, E. H., & Leemput, I. A. V. D.
    (2021). Evaluating the performance of multivariate indicators of
    resilience loss. *Scientific Reports*, *11*(1), 9148.

-   Vignette oficial:
    <https://cran.r-project.org/web/packages/EWSmethods/vignettes/ews_assessments.html>

    -   Eocene bipolar glaciation associated with global carbon cycle
        changes A. Tripati, J. Backman, H. Elderfield, P. Ferretti.
        Nature, Vol 436(7049), pp. 341--346. Nature Publishing Group.
        2005.

-   Rising variability, not slowing down, as a leading indicator of a
    stochastically driven abrupt transition in a dryland ecosystem N.
    Chen, C. Jayaprakash, K. Yu, V. Guttal. The American Naturalist, Vol
    191(1), pp. E1--E14. University of Chicago Press Chicago, IL. 2018.

-   Cultural responses to climate change during the late Holocene P.B.
    DeMenocal. Science, Vol 292(5517), pp. 667--673. American
    Association for the Advancement of Science. 2001.
